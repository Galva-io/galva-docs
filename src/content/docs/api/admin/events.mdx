---
title: Lifecycle Events
description: Trigger automation workflows and log subscription lifecycle events
---

The `/events` endpoint logs real-time subscription lifecycle events. Unlike `/identify`, this endpoint **triggers automation workflows** such as win-back campaigns, save flows, and payment recovery.

## Endpoint

```http title="Events Endpoint"
POST https://api.galva.io/v1/events
```

## Purpose

Use this endpoint to:
- Log subscription lifecycle events (subscribed, renewed, cancelled, etc.)
- Trigger automation workflows (win-back emails, save campaigns, payment recovery)
- Update specific subscription entitlement status (patch update)
- Track subscription-related revenue for LTV calculations

:::tip[Triggers Workflows]
Unlike `/identify`, the `/events` endpoint **actively triggers** automation workflows based on the event type. Use this when you want to engage users with targeted campaigns.
:::

## Required Fields

All events must include these fields:

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `type` | string | **Yes** | Event name (see [Event Types](#event-types)) |
| `userId` | string | **Yes** | Your internal database user ID |
| `planId` | string | **Yes** | The specific product/subscription ID involved |
| `timestamp` | string | No | ISO 8601 timestamp (defaults to current time if omitted) |
| `data` | object | Varies | Event-specific data (required fields depend on event type) |

## Request Format

### Headers

```http title="Request Headers"
Authorization: Bearer sk_admin_xxxxxxxxxxxxxxxxxx
Content-Type: application/json
```

### Base Request Structure

```typescript title="Event Request Schema"
{
  type: string;                      // REQUIRED: Event type
  userId: string;                    // REQUIRED: User ID
  planId: string;                    // REQUIRED: Product/Plan ID
  timestamp?: string;                // OPTIONAL: ISO 8601 (defaults to now)
  data: {                            // REQUIRED: Event-specific data
    // Fields vary by event type
  };
  currentEntitlements?: Entitlement[]; // OPTIONAL: Full state override
}
```

## Event Types

### 1. New Subscription (`subscribed`)

Triggered when a user starts a new subscription (including trial conversions).

**Effects:**
- Updates entitlement status to `active`
- Triggers "Trial Conversion" workflows
- Increments LTV if `amountPaid` is provided

**Request:**

```json
{
  "type": "subscribed",
  "userId": "db_user_123",
  "planId": "com.app.premium_monthly",
  "timestamp": "2024-05-20T10:00:00Z",
  "data": {
    "expirationDate": "2024-06-20T10:00:00Z",
    "isTrial": false,
    "amountPaid": 9.99
  }
}
```

**Data Fields:**

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `expirationDate` | string | **Yes** | ISO 8601 timestamp when subscription expires |
| `isTrial` | boolean | No | `true` if this is a free trial start, `false` for paid (default: `false`) |
| `amountPaid` | number | No | Revenue amount in USD. Adds to user's LTV. |

**Example:**

```bash
curl -X POST https://api.galva.io/v1/events \
  -H "Authorization: Bearer sk_admin_xxxxxxxxxxxxxxxxxx" \
  -H "Content-Type: application/json" \
  -d '{
    "type": "subscribed",
    "userId": "user_123",
    "planId": "gold_monthly",
    "data": {
      "expirationDate": "2025-02-20T10:00:00Z",
      "isTrial": false,
      "amountPaid": 9.99
    }
  }'
```

---

### 2. Renewal (`renewed`)

Triggered when a subscription is successfully renewed.

**Effects:**
- Updates status to `active`
- Extends `expiresAt` date
- Stops active "Win-Back" campaigns
- Increments LTV if `amountPaid` is provided

**Request:**

```json
{
  "type": "renewed",
  "userId": "db_user_123",
  "planId": "com.app.premium_monthly",
  "timestamp": "2024-06-20T10:00:00Z",
  "data": {
    "expirationDate": "2024-07-20T10:00:00Z",
    "amountPaid": 9.99
  }
}
```

**Data Fields:**

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `expirationDate` | string | **Yes** | New expiration date after renewal |
| `amountPaid` | number | No | Revenue amount in USD |

**Example:**

```bash
curl -X POST https://api.galva.io/v1/events \
  -H "Authorization: Bearer sk_admin_xxxxxxxxxxxxxxxxxx" \
  -H "Content-Type: application/json" \
  -d '{
    "type": "renewed",
    "userId": "user_456",
    "planId": "premium_annual",
    "data": {
      "expirationDate": "2026-01-20T00:00:00Z",
      "amountPaid": 99.99
    }
  }'
```

---

### 3. Cancellation (`cancelled`)

Triggered when a user cancels their subscription.

**Effects:**
- Updates `autoRenew` to `false`
- Triggers "Pre-Churn Save" flow if `isStillActive: true`
- Triggers "Win-Back" flow if `isStillActive: false`

**Request:**

```json
{
  "type": "cancelled",
  "userId": "db_user_123",
  "planId": "com.app.premium_monthly",
  "timestamp": "2024-06-15T08:30:00Z",
  "data": {
    "isStillActive": true,
    "reason": "too_expensive"
  }
}
```

**Data Fields:**

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `isStillActive` | boolean | **Yes** | `true` if user still has access (cancelled but not expired). `false` if already expired. |
| `reason` | string | No | Cancellation reason for analytics |

**Critical Field: `isStillActive`**

This field determines which workflow is triggered:

- **`isStillActive: true`** - User cancelled but subscription is still active until expiration date
  - Triggers: "Pre-Churn Save" campaign (try to win them back before they lose access)

- **`isStillActive: false`** - User cancelled and no longer has access
  - Triggers: "Win-Back" campaign (re-engage expired users)

**Example - Cancel but Still Active:**

```bash
# User cancels on June 15, but subscription expires July 1
curl -X POST https://api.galva.io/v1/events \
  -H "Authorization: Bearer sk_admin_xxxxxxxxxxxxxxxxxx" \
  -H "Content-Type: application/json" \
  -d '{
    "type": "cancelled",
    "userId": "user_789",
    "planId": "premium_monthly",
    "data": {
      "isStillActive": true,
      "reason": "found_alternative"
    }
  }'
```

**Example - Cancel After Expiration:**

```bash
# User cancelled after subscription already expired
curl -X POST https://api.galva.io/v1/events \
  -H "Authorization: Bearer sk_admin_xxxxxxxxxxxxxxxxxx" \
  -H "Content-Type: application/json" \
  -d '{
    "type": "cancelled",
    "userId": "user_999",
    "planId": "premium_monthly",
    "data": {
      "isStillActive": false,
      "reason": "no_longer_needed"
    }
  }'
```

---

### 4. Reactivation (`reactivated`)

Triggered when a user reactivates a previously cancelled subscription.

**Effects:**
- Updates `autoRenew` to `true`
- Stops "Pre-Churn Save" campaigns
- Optionally updates expiration date if changed

**Request:**

```json
{
  "type": "reactivated",
  "userId": "db_user_123",
  "planId": "com.app.premium_monthly",
  "timestamp": "2024-06-18T09:00:00Z",
  "data": {
    "expirationDate": "2024-07-20T10:00:00Z"
  }
}
```

**Data Fields:**

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `expirationDate` | string | No | New expiration date if it changed upon reactivation |

**Example:**

```bash
curl -X POST https://api.galva.io/v1/events \
  -H "Authorization: Bearer sk_admin_xxxxxxxxxxxxxxxxxx" \
  -H "Content-Type: application/json" \
  -d '{
    "type": "reactivated",
    "userId": "user_555",
    "planId": "gold_yearly",
    "data": {
      "expirationDate": "2026-01-01T00:00:00Z"
    }
  }'
```

---

### 5. Payment Failure (`payment_failed`)

Triggered when a subscription renewal payment fails.

**Effects:**
- Updates status to `billing_retry`
- Triggers "Payment Recovery" workflows
- Optionally sets grace period expiration

**Request:**

```json
{
  "type": "payment_failed",
  "userId": "db_user_123",
  "planId": "com.app.premium_monthly",
  "timestamp": "2024-06-20T10:00:05Z",
  "data": {
    "reason": "insufficient_funds",
    "gracePeriodExpiresAt": "2024-06-27T10:00:00Z"
  }
}
```

**Data Fields:**

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `reason` | string | No | Failure reason (e.g., `insufficient_funds`, `card_declined`) |
| `gracePeriodExpiresAt` | string | No | ISO 8601 timestamp when grace period ends |

**Example:**

```bash
curl -X POST https://api.galva.io/v1/events \
  -H "Authorization: Bearer sk_admin_xxxxxxxxxxxxxxxxxx" \
  -H "Content-Type: application/json" \
  -d '{
    "type": "payment_failed",
    "userId": "user_333",
    "planId": "premium_monthly",
    "data": {
      "reason": "card_expired",
      "gracePeriodExpiresAt": "2025-02-10T00:00:00Z"
    }
  }'
```

---

### 6. Expiration (`expired`)

Triggered when a subscription expires (either voluntary or due to payment failure).

**Effects:**
- Updates status to `expired`
- Triggers "Win-Back" campaigns
- Marks user as churned for analytics

**Request:**

```json
{
  "type": "expired",
  "userId": "db_user_123",
  "planId": "com.app.premium_monthly",
  "timestamp": "2024-07-20T00:00:00Z",
  "data": {
    "reason": "voluntary"
  }
}
```

**Data Fields:**

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `reason` | string | No | `voluntary` (user cancelled) or `billing_error` (payment failed) |

**Example:**

```bash
curl -X POST https://api.galva.io/v1/events \
  -H "Authorization: Bearer sk_admin_xxxxxxxxxxxxxxxxxx" \
  -H "Content-Type: application/json" \
  -d '{
    "type": "expired",
    "userId": "user_777",
    "planId": "gold_monthly",
    "data": {
      "reason": "voluntary"
    }
  }'
```

---

## Full State Override

Similar to `/identify`, you can include `currentEntitlements` to override the complete subscription state for a user.

### When to Use

Use `currentEntitlements` when you want to:
- Ensure Galva has the exact same state as your database
- Correct any state drift between systems
- Provide redundancy in case previous events were missed

### Example

```json
{
  "type": "renewed",
  "userId": "user_123",
  "planId": "premium_monthly",
  "data": {
    "expirationDate": "2025-03-01T00:00:00Z",
    "amountPaid": 9.99
  },
  "currentEntitlements": [
    {
      "planId": "premium_monthly",
      "status": "active",
      "expiresAt": "2025-03-01T00:00:00Z",
      "autoRenew": true,
      "source": "stripe"
    },
    {
      "planId": "addon_feature",
      "status": "active",
      "expiresAt": "2025-03-01T00:00:00Z",
      "autoRenew": true,
      "source": "stripe"
    }
  ]
}
```

:::caution[Complete Replacement]
Including `currentEntitlements` **completely replaces** all existing entitlements for the user, just like in `/identify`.
:::

---

## Response Format

### Success Response (200 OK)

```json
{
  "success": true,
  "userId": "user_123",
  "eventId": "evt_abc123"
}
```

### Error Responses

#### 400 Bad Request - Missing Required Fields

```json
{
  "error": {
    "type": "validation_error",
    "message": "Missing required field: planId"
  }
}
```

#### 400 Bad Request - Invalid Event Type

```json
{
  "error": {
    "type": "validation_error",
    "message": "Invalid event type: 'subscribe'. Did you mean 'subscribed'?"
  }
}
```

#### 401 Unauthorized

```json
{
  "error": {
    "type": "authentication_error",
    "message": "Invalid API key"
  }
}
```

#### 429 Too Many Requests

```json
{
  "error": {
    "type": "rate_limit_error",
    "message": "Rate limit exceeded"
  }
}
```

---

## Code Examples

import { Tabs, TabItem } from '@astrojs/starlight/components';

<Tabs>
<TabItem label="JavaScript">

```javascript title="track-event.js" collapse={1-27}
async function trackEvent(type, userId, planId, data, currentEntitlements = null) {
  const payload = {
    type,
    userId,
    planId,
    data
  };

  if (currentEntitlements) {
    payload.currentEntitlements = currentEntitlements;
  }

  const response = await fetch('https://api.galva.io/v1/events', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${process.env.GALVA_ADMIN_API_KEY}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(payload)
  });

  if (!response.ok) {
    throw new Error(`Event tracking failed: ${response.statusText}`);
  }

  return await response.json();
}

// Usage examples:

// Track new subscription
await trackEvent('subscribed', 'user_123', 'premium_monthly', {
  expirationDate: '2025-03-01T00:00:00Z',
  isTrial: false,
  amountPaid: 9.99
});

// Track renewal
await trackEvent('renewed', 'user_456', 'gold_annual', {
  expirationDate: '2026-01-01T00:00:00Z',
  amountPaid: 99.99
});

// Track cancellation (still active)
await trackEvent('cancelled', 'user_789', 'premium_monthly', {
  isStillActive: true,
  reason: 'too_expensive'
});

// Track payment failure
await trackEvent('payment_failed', 'user_999', 'premium_monthly', {
  reason: 'card_declined',
  gracePeriodExpiresAt: '2025-02-10T00:00:00Z'
});
```

</TabItem>
<TabItem label="Python">

```python title="track_event.py" collapse={1-26}
import requests
import os
from datetime import datetime

def track_event(event_type, user_id, plan_id, data, current_entitlements=None):
    url = 'https://api.galva.io/v1/events'
    headers = {
        'Authorization': f'Bearer {os.environ["GALVA_ADMIN_API_KEY"]}',
        'Content-Type': 'application/json'
    }

    payload = {
        'type': event_type,
        'userId': user_id,
        'planId': plan_id,
        'data': data
    }

    if current_entitlements:
        payload['currentEntitlements'] = current_entitlements

    response = requests.post(url, headers=headers, json=payload)
    response.raise_for_status()
    return response.json()

# Usage examples:

# Track new subscription
track_event('subscribed', 'user_123', 'premium_monthly', {
    'expirationDate': '2025-03-01T00:00:00Z',
    'isTrial': False,
    'amountPaid': 9.99
})

# Track expiration
track_event('expired', 'user_456', 'gold_monthly', {
    'reason': 'voluntary'
})
```

</TabItem>
<TabItem label="PHP">

```php title="track-event.php" collapse={3-38}
<?php

function trackEvent($type, $userId, $planId, $data, $currentEntitlements = null) {
    $url = 'https://api.galva.io/v1/events';
    $apiKey = getenv('GALVA_ADMIN_API_KEY');

    $payload = [
        'type' => $type,
        'userId' => $userId,
        'planId' => $planId,
        'data' => $data
    ];

    if ($currentEntitlements) {
        $payload['currentEntitlements'] = $currentEntitlements;
    }

    $ch = curl_init($url);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    curl_setopt($ch, CURLOPT_POST, true);
    curl_setopt($ch, CURLOPT_HTTPHEADER, [
        'Authorization: Bearer ' . $apiKey,
        'Content-Type: application/json'
    ]);
    curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($payload));

    $response = curl_exec($ch);
    $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
    curl_close($ch);

    if ($httpCode !== 200) {
        throw new Exception("Event tracking failed: " . $response);
    }

    return json_decode($response, true);
}

// Usage:
trackEvent('subscribed', 'user_123', 'premium_monthly', [
    'expirationDate' => '2025-03-01T00:00:00Z',
    'isTrial' => false,
    'amountPaid' => 9.99
]);
?>
```

</TabItem>
</Tabs>

---

## Integration Patterns

### Webhook Handler

```javascript
// Express.js webhook handler for Stripe

app.post('/webhooks/stripe', async (req, res) => {
  const event = req.body;

  try {
    switch (event.type) {
      case 'invoice.payment_succeeded':
        await trackEvent('renewed', event.data.object.customer, event.data.object.lines.data[0].price.id, {
          expirationDate: new Date(event.data.object.period_end * 1000).toISOString(),
          amountPaid: event.data.object.amount_paid / 100
        });
        break;

      case 'invoice.payment_failed':
        await trackEvent('payment_failed', event.data.object.customer, event.data.object.lines.data[0].price.id, {
          reason: event.data.object.failure_reason || 'unknown'
        });
        break;

      case 'customer.subscription.deleted':
        await trackEvent('cancelled', event.data.object.customer, event.data.object.plan.id, {
          isStillActive: event.data.object.status === 'active',
          reason: event.data.object.cancellation_details?.reason
        });
        break;
    }

    res.json({ received: true });
  } catch (error) {
    console.error('Webhook error:', error);
    res.status(500).json({ error: error.message });
  }
});
```

### Database Trigger

```javascript
// PostgreSQL trigger to sync events

db.on('subscription_updated', async (subscription) => {
  if (subscription.status === 'expired' && subscription.previous_status === 'active') {
    await trackEvent('expired', subscription.user_id, subscription.plan_id, {
      reason: subscription.cancelled_at ? 'voluntary' : 'billing_error'
    });
  }
});
```

---

## Best Practices

### 1. Always Include Timestamps

```javascript
// Good: Explicit timestamp
await trackEvent('subscribed', userId, planId, {
  expirationDate: '2025-03-01T00:00:00Z',
  amountPaid: 9.99
}, { timestamp: subscription.created_at });

// Acceptable: Defaults to current time
await trackEvent('subscribed', userId, planId, {
  expirationDate: '2025-03-01T00:00:00Z',
  amountPaid: 9.99
});
```

### 2. Use Correct Event Types

Don't confuse similar events:

| Scenario | Correct Event |
|----------|---------------|
| User subscribes for first time | `subscribed` |
| User's subscription auto-renews | `renewed` |
| User cancels but still has access | `cancelled` (with `isStillActive: true`) |
| User's subscription lapses | `expired` |
| Payment fails | `payment_failed` |
| User reactivates cancelled subscription | `reactivated` |

### 3. Track Revenue Accurately

Always include `amountPaid` for revenue events:

```javascript
// Good: Includes revenue
await trackEvent('subscribed', userId, planId, {
  expirationDate: '2025-03-01T00:00:00Z',
  amountPaid: 9.99  // ✓ Tracks LTV
});

// Incomplete: Missing revenue
await trackEvent('subscribed', userId, planId, {
  expirationDate: '2025-03-01T00:00:00Z'
  // ✗ LTV won't be updated
});
```

### 4. Use `isStillActive` Correctly

For cancellations, determine if the user still has access:

```javascript
// User cancels today, expires in 30 days
await trackEvent('cancelled', userId, planId, {
  isStillActive: true,  // ✓ Still has access - triggers Save campaign
  reason: 'too_expensive'
});

// User cancels after already expired
await trackEvent('cancelled', userId, planId, {
  isStillActive: false,  // ✓ No access - triggers Win-Back campaign
  reason: 'no_longer_needed'
});
```

### 5. Use State Override for Accuracy

Include `currentEntitlements` when state accuracy is critical:

```javascript
await trackEvent('renewed', userId, planId, {
  expirationDate: '2025-03-01T00:00:00Z',
  amountPaid: 9.99
}, {
  currentEntitlements: [{
    planId: 'premium_monthly',
    status: 'active',
    expiresAt: '2025-03-01T00:00:00Z',
    autoRenew: true,
    source: 'stripe'
  }]
});
```

---

## Related Endpoints

- [Identify](/api/admin/identify) - Sync user state without triggering workflows
- [Batch Identify](/api/admin/batch-identify) - Bulk import historical data
- [Data Objects](/api/admin/data-objects) - Reference for Entitlement objects
- [Errors](/api/admin/errors) - Error handling reference
