---
title: Sync User State (Identify)
description: Create or update user profiles and sync subscription state in real-time
---

The `/identify` endpoint creates or updates a user profile. It performs an upsert operation (update if exists, insert if new) and is designed for real-time synchronization of user state.

## Endpoint

```http title="Identify Endpoint"
POST https://api.galva.io/v1/identify
```

## Purpose

Use this endpoint to:
- Create new user profiles when users sign up
- Update user profile data (email, name, custom attributes)
- Sync the complete subscription state for a user
- Keep Galva in sync with your database in real-time

:::caution[Does Not Trigger Workflows]
The `/identify` endpoint is purely for state synchronization. It does **not** trigger automation workflows like win-back emails or payment recovery. To trigger workflows, use the [`/events`](/api/admin/events) endpoint instead.
:::

## Request Format

### Headers

```http title="Request Headers"
Authorization: Bearer sk_admin_xxxxxxxxxxxxxxxxxx
Content-Type: application/json
```

### Request Body

```typescript title="Request Body Schema"
{
  userId: string;              // REQUIRED
  traits?: UserTraits;         // OPTIONAL
  entitlements?: Entitlement[]; // OPTIONAL
}
```

### Fields

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `userId` | string | **Yes** | Your internal database user ID. This is the primary identifier. |
| `traits` | [UserTraits](/api/admin/data-objects#usertraits-object) | No | Profile data including email, name, LTV, and custom attributes |
| `entitlements` | [Entitlement[]](/api/admin/data-objects#entitlement-object) | No | Complete subscription state. **Overwrites** all existing entitlements if provided. |

## Examples

import { Tabs, TabItem } from '@astrojs/starlight/components';

<Tabs>
<TabItem label="Create New User">

```bash title="Create New User"
curl -X POST https://api.galva.io/v1/identify \
  -H "Authorization: Bearer sk_admin_xxxxxxxxxxxxxxxxxx" \
  -H "Content-Type: application/json" \
  -d '{
    "userId": "db_user_123",
    "traits": {
      "email": "john@example.com",
      "fullName": "John Doe",
      "attributes": {
        "signup_source": "mobile_app"
      }
    }
  }'
```

**Response (200 OK):**

```json title="Success Response"
{
  "success": true,
  "userId": "db_user_123"
}
```

</TabItem>
<TabItem label="Update Email">

```bash title="Update Email Only"
curl -X POST https://api.galva.io/v1/identify \
  -H "Authorization: Bearer sk_admin_xxxxxxxxxxxxxxxxxx" \
  -H "Content-Type: application/json" \
  -d '{
    "userId": "db_user_123",
    "traits": {
      "email": "newemail@example.com"
    }
  }'
```

This updates only the email address without affecting other traits.

</TabItem>
<TabItem label="Sync Complete State">

```bash title="Sync Complete State"
curl -X POST https://api.galva.io/v1/identify \
  -H "Authorization: Bearer sk_admin_xxxxxxxxxxxxxxxxxx" \
  -H "Content-Type: application/json" \
  -d '{
    "userId": "db_user_789",
    "traits": {
      "email": "subscriber@example.com",
      "fullName": "Jane Smith",
      "ltv": 120.00,
      "attributes": {
        "tier": "gold",
        "signup_date": "2024-01-15"
      }
    },
    "entitlements": [
      {
        "planId": "com.app.premium_monthly",
        "status": "active",
        "expiresAt": "2025-02-15T00:00:00Z",
        "autoRenew": true,
        "source": "ios"
      }
    ]
  }'
```

**Response (200 OK):**

```json title="Success Response"
{
  "success": true,
  "userId": "db_user_789"
}
```

</TabItem>
<TabItem label="Update Attributes">

```bash title="Update Attributes"
curl -X POST https://api.galva.io/v1/identify \
  -H "Authorization: Bearer sk_admin_xxxxxxxxxxxxxxxxxx" \
  -H "Content-Type: application/json" \
  -d '{
    "userId": "db_user_456",
    "traits": {
      "attributes": {
        "last_active": "2025-01-20T10:30:00Z",
        "feature_enabled": true
      }
    }
  }'
```

</TabItem>
<TabItem label="Full State Sync">

Use this when you want to ensure Galva has the exact same state as your database:

```bash title="Full State Sync"
curl -X POST https://api.galva.io/v1/identify \
  -H "Authorization: Bearer sk_admin_xxxxxxxxxxxxxxxxxx" \
  -H "Content-Type: application/json" \
  -d '{
    "userId": "db_user_999",
    "traits": {
      "email": "current@example.com",
      "fullName": "Current Name",
      "ltv": 500.00
    },
    "entitlements": [
      {
        "planId": "premium_annual",
        "status": "active",
        "expiresAt": "2026-01-01T00:00:00Z",
        "autoRenew": true,
        "source": "stripe"
      },
      {
        "planId": "addon_feature",
        "status": "active",
        "expiresAt": "2026-01-01T00:00:00Z",
        "autoRenew": true,
        "source": "stripe"
      }
    ]
  }'
```

</TabItem>
</Tabs>

## Code Examples

<Tabs>
<TabItem label="JavaScript">

```javascript title="identify-user.js" collapse={1-20}
async function identifyUser(userId, traits, entitlements) {
  const response = await fetch('https://api.galva.io/v1/identify', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${process.env.GALVA_ADMIN_API_KEY}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      userId,
      traits,
      entitlements
    })
  });

  if (!response.ok) {
    throw new Error(`Failed to identify user: ${response.statusText}`);
  }

  return await response.json();
}

// Usage
await identifyUser('user_123', {
  email: 'user@example.com',
  fullName: 'John Doe',
  attributes: {
    plan: 'premium'
  }
}, [
  {
    planId: 'com.app.premium',
    status: 'active',
    expiresAt: '2025-12-01T00:00:00Z',
    autoRenew: true,
    source: 'ios'
  }
]);
```

</TabItem>
<TabItem label="Python">

```python title="identify_user.py" collapse={1-19}
import requests
import os

def identify_user(user_id, traits=None, entitlements=None):
    url = 'https://api.galva.io/v1/identify'
    headers = {
        'Authorization': f'Bearer {os.environ["GALVA_ADMIN_API_KEY"]}',
        'Content-Type': 'application/json'
    }

    payload = {'userId': user_id}
    if traits:
        payload['traits'] = traits
    if entitlements:
        payload['entitlements'] = entitlements

    response = requests.post(url, headers=headers, json=payload)
    response.raise_for_status()
    return response.json()

# Usage
identify_user(
    user_id='user_123',
    traits={
        'email': 'user@example.com',
        'fullName': 'John Doe',
        'ltv': 150.00
    },
    entitlements=[{
        'planId': 'com.app.premium',
        'status': 'active',
        'expiresAt': '2025-12-01T00:00:00Z',
        'autoRenew': True,
        'source': 'ios'
    }]
)
```

</TabItem>
<TabItem label="PHP">

```php title="identify-user.php" collapse={3-29}
<?php

function identifyUser($userId, $traits = null, $entitlements = null) {
    $url = 'https://api.galva.io/v1/identify';
    $apiKey = getenv('GALVA_ADMIN_API_KEY');

    $payload = ['userId' => $userId];
    if ($traits) $payload['traits'] = $traits;
    if ($entitlements) $payload['entitlements'] = $entitlements;

    $ch = curl_init($url);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    curl_setopt($ch, CURLOPT_POST, true);
    curl_setopt($ch, CURLOPT_HTTPHEADER, [
        'Authorization: Bearer ' . $apiKey,
        'Content-Type: application/json'
    ]);
    curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($payload));

    $response = curl_exec($ch);
    $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
    curl_close($ch);

    if ($httpCode !== 200) {
        throw new Exception("Failed to identify user: " . $response);
    }

    return json_decode($response, true);
}

// Usage
identifyUser('user_123', [
    'email' => 'user@example.com',
    'fullName' => 'John Doe'
]);
?>
```

</TabItem>
</Tabs>

## Response Format

### Success Response (200 OK)

```json title="200 Success"
{
  "success": true,
  "userId": "db_user_123"
}
```

### Error Responses

#### 400 Bad Request - Missing userId

```json title="400 Missing userId"
{
  "error": {
    "type": "validation_error",
    "message": "userId is required"
  }
}
```

#### 400 Bad Request - Invalid Data Format

```json title="400 Invalid Format"
{
  "error": {
    "type": "validation_error",
    "message": "Invalid email format",
    "field": "traits.email"
  }
}
```

#### 401 Unauthorized

```json title="401 Unauthorized"
{
  "error": {
    "type": "authentication_error",
    "message": "Invalid API key"
  }
}
```

#### 429 Too Many Requests

```json title="429 Rate Limited"
{
  "error": {
    "type": "rate_limit_error",
    "message": "Rate limit exceeded. Please retry after 60 seconds."
  }
}
```

## Behavior Details

### Upsert Logic

The endpoint performs an upsert:
- If `userId` exists: Updates the user's data
- If `userId` is new: Creates a new user profile

### Partial Updates

When updating traits:
- Only provided fields are updated
- Omitted fields remain unchanged
- Use `null` to explicitly clear a field

```json
{
  "userId": "user_123",
  "traits": {
    "email": "newemail@example.com"
    // fullName and other fields remain unchanged
  }
}
```

### Entitlements Overwrite

:::danger[Complete Replacement]
When you include the `entitlements` array, it **completely replaces** all existing entitlements for the user. This is useful for full state synchronization but requires caution.
:::

**Before:**
```json
// User has 2 subscriptions
[
  { "planId": "plan_A", "status": "active" },
  { "planId": "plan_B", "status": "active" }
]
```

**Request:**
```json
{
  "userId": "user_123",
  "entitlements": [
    { "planId": "plan_C", "status": "active", ... }
  ]
}
```

**After:**
```json
// User now has only 1 subscription
[
  { "planId": "plan_C", "status": "active" }
]
```

To update individual subscriptions incrementally, use the [`/events`](/api/admin/events) endpoint instead.

## Use Cases

### 1. User Registration

Call `/identify` when a new user signs up:

```javascript
// After user registration in your database
await identifyUser(newUser.id, {
  email: newUser.email,
  fullName: newUser.name,
  attributes: {
    signup_date: new Date().toISOString(),
    signup_source: 'web'
  }
});
```

### 2. Profile Updates

Sync profile changes to Galva:

```javascript
// After user updates their profile
await identifyUser(userId, {
  email: updatedEmail,
  fullName: updatedName
});
```

### 3. Scheduled State Sync

Periodically sync your database state to Galva:

```javascript
// Nightly cron job
const activeSubscribers = await db.getActiveSubscribers();

for (const user of activeSubscribers) {
  await identifyUser(user.id, {
    email: user.email,
    ltv: user.totalSpent
  }, user.subscriptions.map(sub => ({
    planId: sub.productId,
    status: sub.status,
    expiresAt: sub.expiresAt,
    autoRenew: sub.autoRenew,
    source: sub.source
  })));
}
```

### 4. Custom Attribute Tracking

Track business-specific data:

```javascript
// Track feature usage
await identifyUser(userId, {
  attributes: {
    last_feature_used: 'export',
    feature_usage_count: userStats.featureCount,
    power_user: userStats.featureCount > 100
  }
});
```

## Best Practices

1. **Use for State Sync Only** - Don't use `/identify` for events. Use `/events` for subscription lifecycle events.

2. **Include userId Always** - The `userId` field is required and should match your internal database ID.

3. **Partial Updates Are Safe** - You can update just email without affecting subscriptions or other traits.

4. **Be Careful with Entitlements** - Including `entitlements` replaces all subscriptions. Omit it if you only want to update traits.

5. **Idempotent Calls** - Safe to call multiple times with the same data. Galva will handle duplicates gracefully.

6. **Rate Limit Awareness** - Implement retry logic with exponential backoff for 429 errors.

## Related Endpoints

- [Batch Identify](/api/admin/batch-identify) - Bulk import historical users
- [Events](/api/admin/events) - Trigger lifecycle events and workflows
- [Data Objects](/api/admin/data-objects) - Reference for UserTraits and Entitlement objects
